syntax = "proto3";

// Casbinæƒé™è§„åˆ™ä¿¡æ¯
message CasbinRuleInfo {
    optional uint64 id = 1;
    optional int64 created_at = 2;
    optional int64 updated_at = 3;
    optional uint64 tenant_id = 4; // ğŸ”¥ ç§Ÿæˆ·IDå¿…é¡»ï¼Œç¡®ä¿å¤šç§Ÿæˆ·éš”ç¦»
    
    // Casbinæ ‡å‡†å­—æ®µ - ä¸åŸç”ŸCasbiné€‚é…å™¨å…¼å®¹
    string ptype = 5;                // ç­–ç•¥ç±»å‹: p, g, g2ç­‰
    optional string v0 = 6;          // ä¸»ä½“: ç”¨æˆ·IDã€è§’è‰²ä»£ç 
    optional string v1 = 7;          // èµ„æº: èµ„æºè·¯å¾„ã€APIç«¯ç‚¹
    optional string v2 = 8;          // æ“ä½œ: read, write, deleteç­‰
    optional string v3 = 9;          // æ•ˆæœ: allow, deny
    optional string v4 = 10;         // æ¡ä»¶è¡¨è¾¾å¼: JSONæ ¼å¼
    optional string v5 = 11;         // ä¼˜å…ˆçº§: æ•°å€¼å­—ç¬¦ä¸²
    
    // ä¸šåŠ¡æ‰©å±•å­—æ®µ - ä¼ä¸šçº§æƒé™ç®¡ç†
    string service_name = 12;        // æœåŠ¡åç§°: core, cmdb, workflowç­‰
    optional string rule_name = 13;  // è§„åˆ™åç§°: ä¾¿äºè¯†åˆ«
    optional string description = 14; // è§„åˆ™æè¿°
    optional string category = 15;   // è§„åˆ™åˆ†ç±»: system, business, custom
    optional string version = 16;    // è§„åˆ™ç‰ˆæœ¬
    
    // å®¡æ‰¹æµç¨‹å­—æ®µ - ä¼ä¸šçº§å®¡æ‰¹å·¥ä½œæµ
    optional bool require_approval = 17;     // æ˜¯å¦éœ€è¦å®¡æ‰¹
    optional string approval_status = 18;    // å®¡æ‰¹çŠ¶æ€: pending, approved, rejected
    optional uint64 approved_by = 19;        // å®¡æ‰¹äººID
    optional int64 approved_at = 20;         // å®¡æ‰¹æ—¶é—´
    
    // æ—¶é—´æ§åˆ¶å­—æ®µ - ä¸´æ—¶æƒé™æ”¯æŒ
    optional int64 effective_from = 21;      // ç”Ÿæ•ˆå¼€å§‹æ—¶é—´
    optional int64 effective_to = 22;        // ç”Ÿæ•ˆç»“æŸæ—¶é—´
    optional bool is_temporary = 23;         // æ˜¯å¦ä¸ºä¸´æ—¶æƒé™
    
    // ç®¡ç†å­—æ®µ
    optional uint32 status = 24;             // è§„åˆ™çŠ¶æ€: 1=å¯ç”¨, 0=ç¦ç”¨
    optional string metadata = 25;           // å…ƒæ•°æ®JSONå­—ç¬¦ä¸²
    repeated string tags = 26;               // æ ‡ç­¾åˆ—è¡¨
    optional int64 usage_count = 27;         // ä½¿ç”¨æ¬¡æ•°ç»Ÿè®¡
    optional int64 last_used_at = 28;        // æœ€åä½¿ç”¨æ—¶é—´
}

// Casbinè§„åˆ™åˆ—è¡¨è¯·æ±‚
message CasbinRuleListReq {
    uint64 page = 1;
    uint64 page_size = 2;
    
    // è¿‡æ»¤æ¡ä»¶
    optional string service_name = 3;        // æŒ‰æœåŠ¡åç§°è¿‡æ»¤
    optional string ptype = 4;               // æŒ‰ç­–ç•¥ç±»å‹è¿‡æ»¤
    optional string v0 = 5;                  // æŒ‰ä¸»ä½“è¿‡æ»¤
    optional string v1 = 6;                  // æŒ‰èµ„æºè¿‡æ»¤
    optional uint32 status = 7;              // æŒ‰çŠ¶æ€è¿‡æ»¤
    optional string approval_status = 8;     // æŒ‰å®¡æ‰¹çŠ¶æ€è¿‡æ»¤
    optional string category = 9;            // æŒ‰åˆ†ç±»è¿‡æ»¤
    optional bool is_temporary = 10;         // æŒ‰ä¸´æ—¶æƒé™è¿‡æ»¤
    
    // æ—¶é—´èŒƒå›´è¿‡æ»¤
    optional int64 effective_from_start = 11; // ç”Ÿæ•ˆæ—¶é—´èŒƒå›´å¼€å§‹
    optional int64 effective_from_end = 12;   // ç”Ÿæ•ˆæ—¶é—´èŒƒå›´ç»“æŸ
    
    // æœç´¢å…³é”®è¯
    optional string keyword = 13;            // å…³é”®è¯æœç´¢(è§„åˆ™åç§°ã€æè¿°)
    
    // æ’åº
    optional string order_by = 14;           // æ’åºå­—æ®µ
    optional string order_direction = 15;    // æ’åºæ–¹å‘: asc, desc
}

// Casbinè§„åˆ™åˆ—è¡¨å“åº”
message CasbinRuleListResp {
    uint64 total = 1;
    repeated CasbinRuleInfo data = 2;
}

// æƒé™æ£€æŸ¥è¯·æ±‚
message PermissionCheckReq {
    string service_name = 1;        // æœåŠ¡åç§°
    string subject = 2;             // ä¸»ä½“: ç”¨æˆ·IDæˆ–è§’è‰²
    string object = 3;              // èµ„æº: èµ„æºè·¯å¾„
    string action = 4;              // æ“ä½œ: æ“ä½œç±»å‹
    map<string, string> context = 5; // ä¸Šä¸‹æ–‡ä¿¡æ¯: ç”¨äºæ¡ä»¶åŒ–æƒé™åˆ¤æ–­
    
    // å¯é€‰å‚æ•°
    optional bool enable_cache = 6;  // æ˜¯å¦å¯ç”¨ç¼“å­˜
    optional bool audit_log = 7;     // æ˜¯å¦è®°å½•å®¡è®¡æ—¥å¿—
}

// æƒé™æ£€æŸ¥å“åº”
message PermissionCheckResp {
    bool allowed = 1;                        // æ˜¯å¦å…è®¸
    string reason = 2;                       // åŸå› è¯´æ˜
    repeated string applied_rules = 3;       // åº”ç”¨çš„è§„åˆ™IDåˆ—è¡¨
    map<string, string> data_filters = 4;   // æ•°æ®è¿‡æ»¤æ¡ä»¶
    repeated string field_masks = 5;         // å­—æ®µæ©ç åˆ—è¡¨
    int64 check_duration_ms = 6;             // æ£€æŸ¥è€—æ—¶(æ¯«ç§’)
    bool from_cache = 7;                     // æ˜¯å¦æ¥è‡ªç¼“å­˜
}

// æ‰¹é‡æƒé™æ£€æŸ¥è¯·æ±‚
message BatchPermissionCheckReq {
    repeated PermissionCheckReq requests = 1;
    optional bool fail_fast = 2;            // æ˜¯å¦å¿«é€Ÿå¤±è´¥
}

// æ‰¹é‡æƒé™æ£€æŸ¥å“åº”
message BatchPermissionCheckResp {
    repeated PermissionCheckResp responses = 1;
    int32 success_count = 2;                 // æˆåŠŸæ•°é‡
    int32 failed_count = 3;                  // å¤±è´¥æ•°é‡
}

// è§„åˆ™åŒæ­¥è¯·æ±‚
message SyncCasbinRulesReq {
    optional string service_name = 1;       // åŒæ­¥æŒ‡å®šæœåŠ¡çš„è§„åˆ™ï¼Œä¸ºç©ºåˆ™åŒæ­¥æ‰€æœ‰
    optional bool force_reload = 2;         // æ˜¯å¦å¼ºåˆ¶é‡æ–°åŠ è½½
}

// è§„åˆ™åŒæ­¥å“åº”
message SyncCasbinRulesResp {
    int32 synced_count = 1;                 // åŒæ­¥çš„è§„åˆ™æ•°é‡
    repeated string synced_services = 2;    // åŒæ­¥çš„æœåŠ¡åˆ—è¡¨
    int64 sync_duration_ms = 3;             // åŒæ­¥è€—æ—¶
}

// åˆ·æ–°ç¼“å­˜è¯·æ±‚
message RefreshCasbinCacheReq {
    optional string cache_type = 1;         // ç¼“å­˜ç±»å‹: rule, decision, all
    optional string service_name = 2;       // æŒ‡å®šæœåŠ¡
}

// åˆ·æ–°ç¼“å­˜å“åº”
message RefreshCasbinCacheResp {
    bool success = 1;
    string message = 2;
    int32 cleared_entries = 3;              // æ¸…ç†çš„ç¼“å­˜æ¡ç›®æ•°
}

// æƒé™è§„åˆ™éªŒè¯è¯·æ±‚
message ValidateCasbinRuleReq {
    CasbinRuleInfo rule = 1;
    optional bool check_conflicts = 2;      // æ˜¯å¦æ£€æŸ¥å†²çª
}

// æƒé™è§„åˆ™éªŒè¯å“åº”
message ValidateCasbinRuleResp {
    bool valid = 1;
    repeated string errors = 2;             // éªŒè¯é”™è¯¯åˆ—è¡¨
    repeated string warnings = 3;           // è­¦å‘Šä¿¡æ¯åˆ—è¡¨
    repeated string conflicts = 4;          // å†²çªè§„åˆ™IDåˆ—è¡¨
}

// è·å–ç”¨æˆ·æƒé™æ‘˜è¦è¯·æ±‚
message GetUserPermissionSummaryReq {
    string user_id = 1;
    optional string service_name = 2;
    optional bool include_inherited = 3;    // æ˜¯å¦åŒ…å«ç»§æ‰¿æƒé™
}

// æƒé™æ‘˜è¦ä¿¡æ¯
message PermissionSummary {
    string resource = 1;
    repeated string actions = 2;
    string source = 3;                      // æƒé™æ¥æº: direct, inherited
    optional string rule_id = 4;
}

// è·å–ç”¨æˆ·æƒé™æ‘˜è¦å“åº”
message GetUserPermissionSummaryResp {
    string user_id = 1;
    repeated PermissionSummary permissions = 2;
    int32 total_count = 3;
}

// æ‰¹é‡åˆ›å»ºCasbinè§„åˆ™è¯·æ±‚
message BatchCreateCasbinRulesReq {
    repeated CasbinRuleInfo rules = 1;
}

// æ‰¹é‡æ›´æ–°Casbinè§„åˆ™è¯·æ±‚
message BatchUpdateCasbinRulesReq {
    repeated CasbinRuleInfo rules = 1;
}

// Casbinæƒé™ç®¡ç†æœåŠ¡
service Core {
    // æƒé™è§„åˆ™ç®¡ç†
    // group: casbin
    rpc createCasbinRule (CasbinRuleInfo) returns (BaseIDResp);
    // group: casbin
    rpc updateCasbinRule (CasbinRuleInfo) returns (BaseResp);
    // group: casbin
    rpc deleteCasbinRule (IDsReq) returns (BaseResp);
    // group: casbin
    rpc getCasbinRuleList (CasbinRuleListReq) returns (CasbinRuleListResp);
    // group: casbin
    rpc getCasbinRuleById (IDReq) returns (CasbinRuleInfo);
    
    // æ‰¹é‡æ“ä½œ
    // group: casbin
    rpc batchCreateCasbinRules (BatchCreateCasbinRulesReq) returns (BaseResp);
    // group: casbin
    rpc batchUpdateCasbinRules (BatchUpdateCasbinRulesReq) returns (BaseResp);
    // group: casbin
    rpc batchDeleteCasbinRules (IDsReq) returns (BaseResp);
    
    // æƒé™éªŒè¯
    // group: casbin
    rpc checkPermission (PermissionCheckReq) returns (PermissionCheckResp);
    // group: casbin
    rpc batchCheckPermission (BatchPermissionCheckReq) returns (BatchPermissionCheckResp);
    
    // æƒé™æŸ¥è¯¢
    // group: casbin
    rpc getUserPermissionSummary (GetUserPermissionSummaryReq) returns (GetUserPermissionSummaryResp);
    
    // è§„åˆ™éªŒè¯
    // group: casbin
    rpc validateCasbinRule (ValidateCasbinRuleReq) returns (ValidateCasbinRuleResp);
    
    // ç³»ç»Ÿç®¡ç†
    // group: casbin
    rpc syncCasbinRules (SyncCasbinRulesReq) returns (SyncCasbinRulesResp);
    // group: casbin
    rpc refreshCasbinCache (RefreshCasbinCacheReq) returns (RefreshCasbinCacheResp);
}